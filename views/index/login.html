{% extends "layout/index.html" %}

{% block head %}
	<style type="text/css">
		form { margin:auto; width:360px; }
		form label { display:inline-block; width:100px; text-align:right; }
		form h2 { width:100%; text-align:center; color:#990000; margin-top:30px; font-weight:bold; }

	</style>
{% endblock %}

{% block main %}


<form name="loginForm" method="post">
	<p>
		<h2>用户登录</h2>
	</p>
	<p>
		<label>登录名：</label>
		<input type="text" name="login">
	</p>
	<p>
		<label>登录密码：</label>
		<input type="password" name="password">
	</p>
	<p>
	<p>
		<label>验证码：</label>
		<input type="text" name="captcha">
		<img  title="点击刷新" src="{{ baseURL }}/captcha" align="absbottom" onclick="this.src='{{ baseURL }}/captcha?'+Math.random();"></img>
	</p>

	<p class="text-center">
		<input type="button" value="登录" onclick="doLogin()">
	</p>
</form>
<input type="text" name="error" hidden="true" value="{{ errorMessage }}">
{% endblock %}


{% block script %}
<script type="text/javascript" src="{{ baseURL }}/js/rsa/RSA.js"></script>
<script type="text/javascript" src="{{ baseURL }}/js/rsa/BigInt.js"></script>
<script type="text/javascript" src="{{ baseURL }}/js/rsa/Barrett.js"></script>
<script type="text/javascript" src="{{ baseURL }}/js/md5.min.js"></script>
<script type="text/javascript" src="{{ baseURL }}/js/public_key.js"></script>
<script type="text/javascript" src="{{ baseURL }}/own/Panel.js"></script>
<script type="text/javascript">
R.enterMove();

function panelMsg(msg) {
	if (window.panel) {
		panel.show();
		panel.setHTML('<p><br><br>' + msg + '</p>');
	} else {
		window.panel = new Panel({
			html: '<p><br><br>' + msg + '</p>',
			style: '.panel > header * {color:#ffffff;}',
		});
	}
	panel.hide(2000);
}

var error = R('[name="error"]').value;
if (error!='') {
	panelMsg(error);
}


function doLogin() {
	var pwd     = R('[name="password"]'),
		login 	= R('[name="login"]').value,
		captcha	= R('[name="captcha"]').value,
		password= pwd.value;

	if (login.length<3) {
		panelMsg('登录名不得小于3位!');
	} else if (password.length<3) {
		panelMsg('登录密码不得小于3位!');
	} else if (captcha.length!=4) {
		panelMsg('验证码应为4位!');
	} else {
		setMaxDigits(131);
		var key  = new RSAKeyPair("10001", '', PUBLIC_KEY);
		pwd.value = encryptedString(key, md5(md5(password)+captcha));
		document.loginForm.submit();
	}
}
	
</script>
{% endblock %}